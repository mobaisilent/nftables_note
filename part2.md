# 1.流量处理流程

## 1.进入本地的流量处理

### **1. 入站流量处理**

- **进入设备**：数据包到达网络设备的某个接口。
- nftables `prerouting` 链
  - 数据包首先进入 nftables 的 **`prerouting`** 链，应用 **`route`** 链的规则（如 **`type route hook prerouting`**）。
  - 在 **`prerouting`** 链中，数据包可以被标记、修改或重定向。
- 路由决策
  - 在经过 **`prerouting`** 链理后，系统会查阅路由表，决定数据包的最终目的地（本地交付或转发到另一个接口）。
- nftables `input` 链
  - 如果数据包的最终目的地是本地主机，它会进入 **`input`** 链，在这里应用更多的过滤规则。
- **应用层处理**：数据包最终到达目标应用程序或服务。

### **2. 出站流量处理**

- **生成数据包**：本地主机上的应用程序生成数据包。
- 路由决策
  - 系统会查阅路由表，决定数据包的下一跳（通过哪个接口发送到外部网络）。
- nftables `output` 链
  - 数据包首先进入 nftables 的 **`output`** 链，应用相关的过滤和 NAT 规则。
- nftables `postrouting` 链
  - 数据包在最终发送前进入 **`postrouting`** 链，这里可以再次应用 NAT 等规则。
- **发送数据包**：数据包通过路由表决定的接口发送到外部网络

## **2. 转发流量处理**

- **进入设备**：数据包到达网络设备的某个接口。
- nftables `prerouting` 链
  - 数据包首先进入 **`prerouting`** 链，应用 **`route`** 链的规则。
- 路由决策
  - 系统查阅路由表，决定数据包的下一跳（通过哪个接口转发）。
- nftables `forward` 链
  - 如果数据包需要转发到其他网络，它会进入 **`forward`** 链，应用过滤规则。
  - 数据包进入 **`forward`** 链，应用相关的过滤规则
- nftables `postrouting` 链
  - 在转发之前，数据包进入 **`postrouting`** 链，应用 NAT 等规则。
- **转发数据包**：数据包通过路由表决定的接口发送到下一个目的地。